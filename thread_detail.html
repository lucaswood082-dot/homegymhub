<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thread Detail – HomeGymHub</title>
<link rel="stylesheet" href="thread_detail.css">
<style>
  /* Make subtitle bigger and move it closer to the title */
  .threads-hero .hero-content p {
    margin-top: 4px;       /* Less space below title */
    font-size: 1.15rem;    /* Slightly bigger for readability */
    font-weight: 500;
    color: #f8fafc;        /* Keep consistent with header gradient */
  }
</style>
</head>
<body>

<button class="back-btn" onclick="window.location.href='threads.html'">← Back</button>

<header class="threads-hero">
  <div class="hero-content">
    <h1 id="threadTitleHeader">Thread</h1>
  </div>
</header>

<main class="threads-main">
  <!-- Post Reply Form -->
  <section class="reply-post-section">
    <form id="newReplyForm" class="reply-form">
      <textarea id="replyBody" placeholder="Write your reply..." required></textarea>
      <button type="submit" class="btn primary">Post Reply</button>
    </form>
  </section>

  <!-- Replies Section -->
  <section class="thread-replies-section">
    <div id="repliesFeed" class="replies-feed">
      <!-- Replies will load here -->
    </div>
  </section>
</main>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://nqomiajgtmxxsupjgvvu.supabase.co",
  "sb_publishable_b8tpSFMffPkoDRqehct7nQ_g5HjWpxA"
);

const repliesFeed = document.getElementById("repliesFeed");
const newReplyForm = document.getElementById("newReplyForm");
const replyBody = document.getElementById("replyBody");
const threadTitleHeader = document.getElementById("threadTitleHeader");
const threadDescHeader = document.getElementById("threadDescHeader");

// Get thread_id from URL
const urlParams = new URLSearchParams(window.location.search);
const thread_id = urlParams.get("thread_id");

if (!thread_id) {
  repliesFeed.innerHTML = "<p class='error-msg'>No thread selected.</p>";
}

// Load thread info
async function loadThread() {
  const { data, error } = await supabase
    .from("main_threads")
    .select("*")
    .eq("id", thread_id)
    .single();

  if (error || !data) {
    threadTitleHeader.textContent = "Thread not found";
    threadDescHeader.textContent = "";
    return;
  }

  threadTitleHeader.textContent = data.title;
  threadDescHeader.textContent = data.description || "";
}

// Load replies with display names
async function loadReplies() {
  const { data, error } = await supabase
    .from("replies")
    .select(`
      body,
      created_at,
      profiles!inner(display_name)
    `)
    .eq("main_thread_id", thread_id)
    .order("created_at", { ascending: true });

  if (error) {
    repliesFeed.innerHTML = "<p class='error-msg'>Error loading replies</p>";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    repliesFeed.innerHTML = "<p class='empty-msg'>No replies yet. Be the first!</p>";
    return;
  }

  repliesFeed.innerHTML = data.map(r => `
    <div class="reply-card">
      <strong>${r.profiles.display_name}</strong>
      <p>${r.body}</p>
      <span class="reply-date">${new Date(r.created_at).toLocaleString()}</span>
    </div>
  `).join("");
}

// Post new reply
newReplyForm.addEventListener("submit", async e => {
  e.preventDefault();
  const body = replyBody.value.trim();
  if (!body) return;

  // Get current logged-in user
  const { data: { user }, error: userError } = await supabase.auth.getUser();
  if (userError || !user) return alert("You must be logged in to post.");

  const userId = user.id;

  // Ensure profile exists
  const { data: profileData } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .single();

  if (!profileData) {
    const { error: insertError } = await supabase
      .from("profiles")
      .insert([{ id: userId, display_name: "Your Name" }]);
    if (insertError) {
      console.error("Error creating profile:", insertError);
      return alert("Cannot create profile. Check console.");
    }
  }

  // Insert reply
  const { data: replyData, error: replyError } = await supabase
    .from("replies")
    .insert([{ body, main_thread_id: thread_id, author_id: userId }])
    .select();

  if (replyError) {
    console.error(replyError);
    return alert("Error posting reply");
  }

  replyBody.value = "";

  // Append new reply
  const newReply = replyData[0];
  const replyCard = document.createElement("div");
  replyCard.className = "reply-card animate-card";
  replyCard.style.animationDelay = "0s";
  replyCard.innerHTML = `
    <strong>${profileData?.display_name || "You"}</strong>
    <p>${newReply.body}</p>
    <span class="reply-date">${new Date(newReply.created_at).toLocaleString()}</span>
  `;
  repliesFeed.appendChild(replyCard);
  replyCard.scrollIntoView({ behavior: "smooth", block: "end" });
});

// Initial load
loadThread();
loadReplies();
</script>

</body>
</html>
