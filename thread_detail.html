<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thread Detail – HomeGymHub</title>

<style>
  html {
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #fff 0%, #ffe5cc 20%, #ffccaa 40%, #ff9966 60%, #ffccaa 80%, #fff 100%);
    background-size: 400% 400%;
    background-attachment: fixed;
    animation: gradientShift 20s ease infinite;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    min-height: 100%;
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
  }
  body {
    margin: 0;
    padding: 0;
    background: transparent;
    overflow-x: hidden;
    overflow-y: auto;
    overscroll-behavior-y: none;
    overscroll-behavior-x: none;
  }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
</style>

<link rel="stylesheet" href="thread_detail.css">
</head>
<body>

<div class="bg-gradient"></div>
<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="orb orb3"></div>

<button class="back-btn" onclick="window.location.href='threads.html'">← Back</button>

<section class="hero">
  <div class="hero-content">
    <h1 class="hero-title" id="threadTitleHeader">Thread</h1>
  </div>
</section>

<section class="detail-section">
  <div class="detail-container">
    
    <div class="reply-form-card">
      <form id="newReplyForm" class="reply-form">
        <textarea id="replyBody" placeholder="Write your reply..." required></textarea>
        <button type="submit" class="btn primary">Post Reply</button>
      </form>
    </div>

    <div id="repliesFeed" class="replies-list">
    </div>

  </div>
</section>

<div id="toast" class="toast">
  <div class="toast-content">
    <span class="toast-icon">⚠️</span>
    <span class="toast-message"></span>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://nqomiajgtmxxsupjgvvu.supabase.co",
  "sb_publishable_b8tpSFMffPkoDRqehct7nQ_g5HjWpxA"
);

const repliesFeed = document.getElementById("repliesFeed");
const newReplyForm = document.getElementById("newReplyForm");
const replyBody = document.getElementById("replyBody");
const threadTitleHeader = document.getElementById("threadTitleHeader");
const toast = document.getElementById("toast");
const toastMessage = toast.querySelector(".toast-message");

const urlParams = new URLSearchParams(window.location.search);
const thread_id = urlParams.get("thread_id");

const defaultAvatar = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'><path d='M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z'/></svg>";

if (!thread_id) {
  repliesFeed.innerHTML = "<p class='error-msg'>No thread selected.</p>";
}

// Get public URL for profile image from Supabase Storage
function getPublicImageUrl(path) {
  if (!path) return defaultAvatar;
  
  const { data } = supabase.storage
    .from('profile-images')
    .getPublicUrl(path);
  
  return data.publicUrl;
}

function showToast(message) {
  toastMessage.textContent = message;
  toast.classList.add("show");
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

// Load profile image from database
async function getProfileImage(userId) {
  try {
    const { data, error } = await supabase
      .from("profiles")
      .select("profile_image_url")
      .eq("id", userId)
      .single();
    
    if (error || !data) {
      return defaultAvatar;
    }
    
    return getPublicImageUrl(data.profile_image_url);
  } catch (err) {
    console.error("Error loading profile image:", err);
    return defaultAvatar;
  }
}

async function loadThread() {
  const { data, error } = await supabase
    .from("main_threads")
    .select("*")
    .eq("id", thread_id)
    .single();

  if (error || !data) {
    threadTitleHeader.textContent = "Thread not found";
    return;
  }

  threadTitleHeader.textContent = data.title;
}

async function loadReplies() {
  const { data, error } = await supabase
    .from("replies")
    .select(`
      body,
      created_at,
      author_id,
      profiles!inner(display_name)
    `)
    .eq("main_thread_id", thread_id)
    .order("created_at", { ascending: true });

  if (error) {
    repliesFeed.innerHTML = "<p class='error-msg'>Error loading replies</p>";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    repliesFeed.innerHTML = "<p class='empty-msg'>No replies yet. Be the first!</p>";
    return;
  }

  // Load all profile images from Supabase Storage
  const imagePromises = data.map(r => getProfileImage(r.author_id));
  const profileImages = await Promise.all(imagePromises);

  repliesFeed.innerHTML = data.map((r, index) => {
    const profileImg = profileImages[index];
    return `
    <div class="reply-card" style="animation-delay: ${index * 0.08}s">
      <div class="reply-header">
        <div class="reply-author-section">
          <img src="${profileImg}" alt="Profile" class="reply-avatar">
          <strong class="reply-author">${r.profiles.display_name}</strong>
        </div>
        <span class="reply-date">${new Date(r.created_at).toLocaleString()}</span>
      </div>
      <p class="reply-body">${r.body}</p>
    </div>
  `;
  }).join("");

  setTimeout(() => {
    document.querySelectorAll('.reply-card').forEach(card => {
      card.classList.add('animate-card');
    });
  }, 50);
}

newReplyForm.addEventListener("submit", async e => {
  e.preventDefault();
  const body = replyBody.value.trim();
  if (!body) return;

  const { data: { user }, error: userError } = await supabase.auth.getUser();
  if (userError || !user) {
    showToast("You must be logged in to post");
    return;
  }

  const userId = user.id;

  const { data: profileData } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .single();

  if (!profileData) {
    const { error: insertError } = await supabase
      .from("profiles")
      .insert([{ id: userId, display_name: `User${userId.substring(0, 6)}` }]);
    if (insertError) {
      console.error("Error creating profile:", insertError);
      showToast("Cannot create profile. Check console.");
      return;
    }
  }

  const { data: replyData, error: replyError } = await supabase
    .from("replies")
    .insert([{ body, main_thread_id: thread_id, author_id: userId }])
    .select();

  if (replyError) {
    console.error(replyError);
    showToast("Error posting reply");
    return;
  }

  replyBody.value = "";
  showToast("Reply posted!");
  loadReplies();
});

loadThread();
loadReplies();
</script>

</body>
</html>