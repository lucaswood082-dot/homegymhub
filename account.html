<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Account | HomeGymHub</title>
<link rel="stylesheet" href="account.css">
<style>
  #displayNameInput {
    width: 100%;
    padding: 12px 16px;
    margin: 8px 0 12px 0;
    border: 1px solid var(--border);
    border-radius: 16px;
    font-size: 16px;
    outline: none;
    transition: all 0.2s ease;
  }
  #displayNameInput:focus {
    border-color: var(--orange);
    box-shadow: 0 0 12px rgba(249,115,22,0.3);
  }

  #saveNameBtn {
    width: 100%;
    padding: 12px 0;
    border: none;
    border-radius: 16px;
    font-weight: 600;
    font-size: 16px;
    color: #fff;
    background: linear-gradient(135deg, var(--blue), var(--orange));
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 12px;
  }
  #saveNameBtn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow:0 8px 20px rgba(11,31,59,0.25);
  }
  #saveNameBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  #toast {
    visibility: hidden;
    min-width: 220px;
    background: linear-gradient(135deg, var(--blue), var(--orange));
    color: #fff;
    text-align: center;
    border-radius: 16px;
    padding: 14px 20px;
    position: fixed;
    z-index: 1000;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.4s, bottom 0.4s, visibility 0.4s;
  }
  #toast.show {
    visibility: visible;
    opacity: 1;
    bottom: 50px;
  }

  .validation-hint {
    font-size: 12px;
    color: var(--muted);
    margin-top: -8px;
    margin-bottom: 8px;
  }

  .edit-panel {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.4s ease, opacity 0.4s ease, margin-top 0.4s ease;
    margin-top: 0;
  }

  .edit-panel:not(.hidden) {
    max-height: 600px;
    opacity: 1;
    margin-top: 28px;
  }

  .avatar-wrap img {
    min-width: 100%;
    min-height: 100%;
    background: linear-gradient(135deg, #0f2d57, #f97316);
  }

  .profile-card.loading {
    opacity: 0.6;
    pointer-events: none;
  }
</style>
</head>
<body>

  <nav class="nav">
    <div class="nav-inner">
      <div class="brand">HomeGymHub</div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="builder.html">Planner</a>
        <a href="marketplace.html">Marketplace</a>
        <a href="threads.html">Threads</a>
      </div>
      <a class="account-btn" href="account.html">Account</a>
    </div>
  </nav>

  <header class="account-header">
    <a href="index.html" class="back-btn">← Back</a>
    <h1>Your Account</h1>
    <p>Manage your profile and preferences</p>
  </header>

  <main class="account-layout">

    <aside class="side-card">
      <h3>My Listings</h3>
      <p>Marketplace items you sell.</p>
      <span class="pill">Coming Soon</span>
    </aside>

    <section class="profile-card">
      <div class="profile-top">
        <div class="avatar-wrap">
          <img id="profileImg" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'><path d='M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z'/></svg>" alt="Profile picture">
        </div>
        <div class="profile-meta">
          <h2 id="displayName">Loading...</h2>
          <span class="email">Loading...</span>
        </div>
      </div>

      <button id="editBtn" class="btn primary">Edit Profile</button>

      <div id="editPanel" class="edit-panel hidden">
        <label for="displayNameInput" style="font-weight:600;">Display Name:</label>
        <input type="text" id="displayNameInput" placeholder="Enter display name" maxlength="30">
        <p class="validation-hint">3-30 characters. Letters, numbers, spaces, _ and - only.</p>
        <button id="saveNameBtn">Save Name</button>

        <button id="changePicBtn" class="btn secondary" type="button">Change Profile Picture</button>
        <input type="file" id="imgInput" accept="image/*" hidden>
        <button id="doneBtn" class="btn primary">Done</button>
      </div>
    </section>

    <aside class="side-card">
      <h3>Wishlist</h3>
      <p>Items you want to buy later.</p>
      <span class="pill">Coming Soon</span>
    </aside>

  </main>

  <div id="toast"></div>

  <footer class="footer">© 2026 HomeGymHub</footer>
  
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://nqomiajgtmxxsupjgvvu.supabase.co",
      "sb_publishable_b8tpSFMffPkoDRqehct7nQ_g5HjWpxA"
    );

    // DOM Elements
    const editBtn = document.getElementById("editBtn");
    const editPanel = document.getElementById("editPanel");
    const changePicBtn = document.getElementById("changePicBtn");
    const imgInput = document.getElementById("imgInput");
    const profileImg = document.getElementById("profileImg");
    const doneBtn = document.getElementById("doneBtn");
    const displayNameEl = document.getElementById("displayName");
    const displayNameInput = document.getElementById("displayNameInput");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const emailEl = document.querySelector(".email");
    const toast = document.getElementById("toast");

    const defaultAvatar = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'><path d='M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z'/></svg>";

    let currentUser = null;
    let currentProfile = null;

    // Toast function
    function showToast(msg, isError = false) {
      toast.textContent = msg;
      toast.style.background = isError 
        ? "linear-gradient(135deg, #ef4444, #dc2626)" 
        : "linear-gradient(135deg, #0f2d57, #f97316)";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // Load user data from Supabase
    async function loadUserData() {
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError || !user) {
          showToast("Please log in to view your account", true);
          setTimeout(() => window.location.href = "auth.html", 2000);
          return;
        }

        currentUser = user;
        emailEl.textContent = user.email;

        // Load profile image from localStorage first
        const savedImage = localStorage.getItem(`profileImage_${user.id}`);
        if (savedImage && savedImage !== defaultAvatar) {
          profileImg.src = savedImage;
        }

        // Load or create profile
        const { data: profiles, error: profileError } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", user.id);

        if (profileError) {
          console.error("Profile load error:", profileError);
          showToast("Error loading profile", true);
          return;
        }

        if (profiles && profiles.length > 0) {
          // Profile exists
          currentProfile = profiles[0];
          displayNameEl.textContent = currentProfile.display_name || "Your Name";
        } else {
          // Create new profile with default name
          const { data: newProfile, error: createError } = await supabase
            .from("profiles")
            .insert([{ 
              id: user.id, 
              display_name: `User${user.id.substring(0, 6)}`
            }])
            .select();

          if (createError) {
            console.error("Profile creation error:", createError);
            showToast("Error creating profile", true);
            displayNameEl.textContent = "Your Name";
            return;
          }

          if (newProfile && newProfile.length > 0) {
            currentProfile = newProfile[0];
            displayNameEl.textContent = currentProfile.display_name;
          }
        }

      } catch (err) {
        console.error("Load user data error:", err);
        displayNameEl.textContent = "Your Name";
        showToast("Error loading account data", true);
      }
    }

    // Check if display name is available
    async function isDisplayNameAvailable(displayName) {
      try {
        const { data, error } = await supabase
          .from("profiles")
          .select("id")
          .eq("display_name", displayName)
          .neq("id", currentUser.id);

        if (error) {
          console.error("Display name check error:", error);
          return false;
        }
        
        return !data || data.length === 0;
      } catch (err) {
        console.error("Display name check error:", err);
        return false;
      }
    }

    // Validate display name
    function validateDisplayName(name) {
      if (!name || name.trim().length === 0) {
        return { valid: false, error: "Display name cannot be empty" };
      }

      if (name.length < 3) {
        return { valid: false, error: "Display name must be at least 3 characters" };
      }

      if (name.length > 30) {
        return { valid: false, error: "Display name must be less than 30 characters" };
      }

      const validPattern = /^[a-zA-Z0-9_\- ]+$/;
      if (!validPattern.test(name)) {
        return { valid: false, error: "Display name can only contain letters, numbers, spaces, underscores, and hyphens" };
      }

      return { valid: true };
    }

    // Open edit panel
    editBtn.addEventListener("click", () => {
      editPanel.classList.remove("hidden");
      editBtn.classList.add("hidden");
      displayNameInput.value = currentProfile?.display_name || displayNameEl.textContent;
    });

    // Save display name
    saveNameBtn.addEventListener("click", async () => {
      if (!currentUser) {
        showToast("Please log in first", true);
        return;
      }

      const newName = displayNameInput.value.trim();
      
      const validation = validateDisplayName(newName);
      if (!validation.valid) {
        showToast(validation.error, true);
        return;
      }

      if (newName === currentProfile?.display_name) {
        showToast("That's already your display name!");
        return;
      }

      saveNameBtn.disabled = true;
      saveNameBtn.textContent = "Checking...";

      try {
        const isAvailable = await isDisplayNameAvailable(newName);
        
        if (!isAvailable) {
          showToast("This display name is already taken!", true);
          saveNameBtn.disabled = false;
          saveNameBtn.textContent = "Save Name";
          return;
        }

        // Update profile
        const { data, error } = await supabase
          .from("profiles")
          .update({ display_name: newName })
          .eq("id", currentUser.id)
          .select();

        if (error) {
          console.error("Update error:", error);
          
          if (error.code === '23505') {
            showToast("This display name is already taken!", true);
          } else {
            showToast(`Error: ${error.message}`, true);
          }
          
          saveNameBtn.disabled = false;
          saveNameBtn.textContent = "Save Name";
          return;
        }

        if (data && data.length > 0) {
          currentProfile = data[0];
          displayNameEl.textContent = newName;
          showToast("Display name saved!");
        }
        
      } catch (err) {
        console.error("Save error:", err);
        showToast(`Error: ${err.message}`, true);
      } finally {
        saveNameBtn.disabled = false;
        saveNameBtn.textContent = "Save Name";
      }
    });

    // Avatar change
    changePicBtn.addEventListener("click", () => imgInput.click());

    imgInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        showToast("Please select an image file", true);
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        profileImg.src = reader.result;
        showToast("Profile picture updated! Click 'Done' to save.");
      };
      reader.readAsDataURL(file);
      imgInput.value = "";
    });

    // Done editing
    doneBtn.addEventListener("click", () => {
      if (currentUser) {
        localStorage.setItem(`profileImage_${currentUser.id}`, profileImg.src);
      }
      
      editPanel.classList.add("hidden");
      editBtn.classList.remove("hidden");
      showToast("Profile saved!");
    });

    // Load data on page load
    loadUserData();

    // Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT') {
        window.location.href = 'auth.html';
      } else if (event === 'SIGNED_IN') {
        loadUserData();
      }
    });
  </script>
</body>
</html>