<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account | HomeGymHub</title>
  <link rel="stylesheet" href="account.css">
</head>
<body>
  <div class="bg-gradient"></div>
  <div id="particles"></div>

  <nav class="nav">
    <div class="nav-inner">
      <div class="brand" onclick="window.location.href='index.html'">HomeGymHub</div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="builder.html">Planner</a>
        <a href="marketplace.html">Marketplace</a>
        <a href="threads.html">Community</a>
      </div>
      <div class="auth-actions">
        <button id="logoutBtn">Log Out</button>
      </div>
    </div>
  </nav>

  <section class="account-hero">
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div>
      <h1>Your Account</h1>
      <p>Manage your profile and track your fitness journey</p>
    </div>
  </section>

  <main class="account-container">
    <!-- LEFT SIDEBAR - My Listings -->
    <aside class="side-card">
      <h3>My Listings</h3>
      <p>Equipment you're selling on the marketplace</p>
      
      <div class="listings-list" id="myListings">
        <!-- Listings will be added here dynamically -->
        <div class="empty-state">
          <p>No listings yet</p>
          <span class="pill">Coming Soon</span>
        </div>
      </div>
    </aside>

    <!-- CENTER - PROFILE CARD -->
    <section class="profile-card">
      <div class="avatar-section">
        <div class="avatar-wrap">
          <div class="avatar-inner">
            <img id="profileImg" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'><path d='M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z'/></svg>" alt="Profile">
          </div>
          <button class="avatar-edit-btn" id="changeAvatarBtn">✎</button>
          <input type="file" id="avatarInput" accept="image/*" hidden>
        </div>
        
        <div class="profile-info">
          <h2 id="displayNameText">Loading...</h2>
          <span class="email" id="emailText">Loading...</span>
        </div>
      </div>

      <button class="btn primary" id="editProfileBtn">Edit Profile</button>

      <div class="edit-section hidden" id="editSection">
        <div class="form-group">
          <label for="displayNameInput">Display Name</label>
          <input type="text" id="displayNameInput" placeholder="Enter your name" maxlength="30">
          <p class="hint-text">3-30 characters. Letters, numbers, spaces, _ and - only.</p>
        </div>

        <button class="btn primary" id="saveNameBtn">
          <span>Save Changes</span>
        </button>

        <button class="btn secondary" id="cancelBtn">Cancel</button>
      </div>
    </section>

    <!-- RIGHT SIDEBAR - Wishlist -->
    <aside class="side-card">
      <h3>Wishlist</h3>
      <p>Items you want to buy later</p>
      
      <div class="wishlist-grid" id="wishlistItems">
        <!-- Wishlist items will be added here dynamically -->
        <div class="empty-state">
          <p>No items saved yet</p>
          <span class="pill">Coming Soon</span>
        </div>
      </div>
    </aside>
  </main>

  <div id="toast" class="toast"></div>

  <footer class="footer">
    © 2026 HomeGymHub - Building the Future of Home Fitness
  </footer>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://nqomiajgtmxxsupjgvvu.supabase.co",
      "sb_publishable_b8tpSFMffPkoDRqehct7nQ_g5HjWpxA"
    );

    // Particle system
    const particlesContainer = document.getElementById('particles');
    for(let i = 0; i < 40; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = (Math.random() * 12 + 8) + 's';
      p.style.animationDelay = Math.random() * 5 + 's';
      p.style.setProperty('--drift', (Math.random() * 200 - 100) + 'px');
      particlesContainer.appendChild(p);
    }

    // Navbar scroll effect
    const nav = document.querySelector('.nav');
    window.addEventListener('scroll', () => {
      if(window.scrollY > 50) {
        nav.classList.add('scrolled');
      } else {
        nav.classList.remove('scrolled');
      }
    });

    // DOM Elements
    const editProfileBtn = document.getElementById("editProfileBtn");
    const editSection = document.getElementById("editSection");
    const changeAvatarBtn = document.getElementById("changeAvatarBtn");
    const avatarInput = document.getElementById("avatarInput");
    const profileImg = document.getElementById("profileImg");
    const displayNameText = document.getElementById("displayNameText");
    const displayNameInput = document.getElementById("displayNameInput");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const emailText = document.getElementById("emailText");
    const logoutBtn = document.getElementById("logoutBtn");
    const toast = document.getElementById("toast");

    const defaultAvatar = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'><path d='M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z'/></svg>";

    let currentUser = null;
    let currentProfile = null;

    // Toast function
    function showToast(msg, isError = false) {
      toast.textContent = msg;
      toast.className = 'toast ' + (isError ? 'error' : 'success');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Load user data
    async function loadUserData() {
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError || !user) {
          showToast("Please log in to view your account", true);
          setTimeout(() => window.location.href = "auth.html", 2000);
          return;
        }

        currentUser = user;
        emailText.textContent = user.email;

        // Load profile image from localStorage
        const savedImage = localStorage.getItem(`profileImage_${user.id}`);
        if (savedImage && savedImage !== defaultAvatar) {
          profileImg.src = savedImage;
        }

        // Load profile from database
        const { data: profiles, error: profileError } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", user.id);

        if (profileError) {
          console.error("Profile load error:", profileError);
          showToast("Error loading profile", true);
          return;
        }

        if (profiles && profiles.length > 0) {
          currentProfile = profiles[0];
          displayNameText.textContent = currentProfile.display_name || "Your Name";
        } else {
          // Create new profile
          const { data: newProfile, error: createError } = await supabase
            .from("profiles")
            .insert([{ 
              id: user.id, 
              display_name: `User${user.id.substring(0, 6)}`
            }])
            .select();

          if (createError) {
            console.error("Profile creation error:", createError);
            displayNameText.textContent = "Your Name";
            return;
          }

          if (newProfile && newProfile.length > 0) {
            currentProfile = newProfile[0];
            displayNameText.textContent = currentProfile.display_name;
          }
        }
      } catch (err) {
        console.error("Load user data error:", err);
        displayNameText.textContent = "Your Name";
        showToast("Error loading account data", true);
      }
    }

    // Validate display name
    function validateDisplayName(name) {
      if (!name || name.trim().length === 0) {
        return { valid: false, error: "Display name cannot be empty" };
      }
      if (name.length < 3) {
        return { valid: false, error: "Display name must be at least 3 characters" };
      }
      if (name.length > 30) {
        return { valid: false, error: "Display name must be less than 30 characters" };
      }
      const validPattern = /^[a-zA-Z0-9_\- ]+$/;
      if (!validPattern.test(name)) {
        return { valid: false, error: "Display name can only contain letters, numbers, spaces, underscores, and hyphens" };
      }
      return { valid: true };
    }

    // Check if display name is available
    async function isDisplayNameAvailable(displayName) {
      try {
        const { data, error } = await supabase
          .from("profiles")
          .select("id")
          .eq("display_name", displayName)
          .neq("id", currentUser.id);

        if (error) {
          console.error("Display name check error:", error);
          return false;
        }
        return !data || data.length === 0;
      } catch (err) {
        console.error("Display name check error:", err);
        return false;
      }
    }

    // Edit profile button
    editProfileBtn.addEventListener("click", () => {
      editSection.classList.remove("hidden");
      editProfileBtn.style.display = "none";
      displayNameInput.value = currentProfile?.display_name || displayNameText.textContent;
    });

    // Cancel button
    cancelBtn.addEventListener("click", () => {
      editSection.classList.add("hidden");
      editProfileBtn.style.display = "block";
    });

    // Save name button
    saveNameBtn.addEventListener("click", async () => {
      if (!currentUser) {
        showToast("Please log in first", true);
        return;
      }

      const newName = displayNameInput.value.trim();
      
      const validation = validateDisplayName(newName);
      if (!validation.valid) {
        showToast(validation.error, true);
        return;
      }

      if (newName === currentProfile?.display_name) {
        showToast("That's already your display name!");
        return;
      }

      saveNameBtn.disabled = true;
      saveNameBtn.innerHTML = '<span>Saving...</span>';

      try {
        const isAvailable = await isDisplayNameAvailable(newName);
        
        if (!isAvailable) {
          showToast("This display name is already taken!", true);
          saveNameBtn.disabled = false;
          saveNameBtn.innerHTML = '<span>Save Changes</span>';
          return;
        }

        const { data, error } = await supabase
          .from("profiles")
          .update({ display_name: newName })
          .eq("id", currentUser.id)
          .select();

        if (error) {
          console.error("Update error:", error);
          if (error.code === '23505') {
            showToast("This display name is already taken!", true);
          } else {
            showToast(`Error: ${error.message}`, true);
          }
          saveNameBtn.disabled = false;
          saveNameBtn.innerHTML = '<span>Save Changes</span>';
          return;
        }

        if (data && data.length > 0) {
          currentProfile = data[0];
          displayNameText.textContent = newName;
          showToast("Display name saved!");
          editSection.classList.add("hidden");
          editProfileBtn.style.display = "block";
        }
      } catch (err) {
        console.error("Save error:", err);
        showToast(`Error: ${err.message}`, true);
      } finally {
        saveNameBtn.disabled = false;
        saveNameBtn.innerHTML = '<span>Save Changes</span>';
      }
    });

    // Avatar change
    changeAvatarBtn.addEventListener("click", () => avatarInput.click());

    avatarInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        showToast("Please select an image file", true);
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        profileImg.src = reader.result;
        if (currentUser) {
          localStorage.setItem(`profileImage_${currentUser.id}`, reader.result);
        }
        showToast("Profile picture updated!");
      };
      reader.readAsDataURL(file);
      avatarInput.value = "";
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "index.html";
    });

    // Load data on page load
    loadUserData();

    // Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT') {
        window.location.href = 'auth.html';
      } else if (event === 'SIGNED_IN') {
        loadUserData();
      }
    });

    // DEMO: You can add listings dynamically like this later:
    // Example function to add a listing (uncomment when ready to implement)
    /*
    function addListing(title, price) {
      const listingsContainer = document.getElementById('myListings');
      const emptyState = listingsContainer.querySelector('.empty-state');
      if (emptyState) emptyState.remove();
      
      const listing = document.createElement('div');
      listing.className = 'listing-item';
      listing.innerHTML = `
        <div class="listing-title">${title}</div>
        <div class="listing-price">$${price}</div>
      `;
      listingsContainer.appendChild(listing);
    }
    */

    // DEMO: You can add wishlist items dynamically like this later:
    /*
    function addWishlistItem(title) {
      const wishlistContainer = document.getElementById('wishlistItems');
      const emptyState = wishlistContainer.querySelector('.empty-state');
      if (emptyState) emptyState.remove();
      
      const item = document.createElement('div');
      item.className = 'wishlist-item';
      item.innerHTML = `<div class="wishlist-title">${title}</div>`;
      wishlistContainer.appendChild(item);
    }
    */
  </script>
</body>
</html>